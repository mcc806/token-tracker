<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Token Tracker — Team Edition</title>
<style>
:root{
  --bg:#f6f7fb; --card:#fff; --ink:#0f172a; --muted:#64748b;
  --accent:#2563eb; --earn:#16a34a; --loss:#dc2626; --border:#e5e7eb;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
header{position:sticky;top:0;z-index:5;background:#ffffffdd;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.wrap{max-width:1100px;margin:0 auto;padding:14px}
h1{margin:0;font-size:clamp(22px,3vw,28px)}
.sub{color:var(--muted);font-size:13px}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
button,input,select,textarea{font:inherit}
button,.btn{padding:9px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
.primary{background:var(--accent);color:#fff;border-color:transparent}
.ghost{background:#fff}
.danger{background:var(--loss);color:#fff;border-color:transparent}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:16px 0}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 6px 20px rgba(15,23,42,.05)}
.card h2{margin:4px 0 12px 0;font-size:18px}
.list{display:flex;flex-direction:column;gap:8px}
.row{display:grid;grid-template-columns:1fr auto auto auto;gap:10px;align-items:center;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#fff}
.name{font-weight:600}
.value{font-variant-numeric:tabular-nums;font-weight:700}
.value.earn{color:var(--earn)} .value.loss{color:var(--loss)}
.count{justify-self:end;background:#eef2ff;color:#3730a3;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
.row button{justify-self:end}
.summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media(max-width:700px){.summary{grid-template-columns:1fr}}
.stat{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
.stat h3{margin:0 0 6px 0;color:var(--muted);font-size:13px}
.stat .num{font-size:28px;font-weight:800}
.num.earn{color:var(--earn)} .num.loss{color:var(--loss)}
.history{display:flex;flex-direction:column;gap:8px}
.hist-row{display:grid;grid-template-columns:1fr auto auto auto;gap:10px;align-items:center;border:1px dashed var(--border);border-radius:12px;padding:10px 12px;background:#fff}
small{color:var(--muted)}
footer{color:var(--muted);font-size:12px;text-align:center;padding:16px}
/* Modal */
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(15,23,42,.4)}
.modal.open{display:grid}
.sheet{width:min(900px,92vw);max-height:92vh;overflow:auto;background:#fff;border-radius:18px;border:1px solid var(--border);box-shadow:0 30px 60px rgba(0,0,0,.25)}
.sheet header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);border-radius:18px 18px 0 0}
.sheet .body{padding:14px}
.flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
.table input{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:8px}
.kv{display:grid;grid-template-columns:200px 1fr;gap:8px;align-items:center}
code.inline{background:#f1f5f9;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
.badge{display:inline-block;background:#eef2ff;color:#3730a3;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="flex" style="justify-content:space-between">
      <div>
        <h1>Token Tracker — Team Edition</h1>
        <div class="sub">Tap a behavior to log it. Edit items in <strong>Settings</strong>. (Optional) enable <strong>Cloud Sync</strong> to share with coworkers.</div>
      </div>
      <div class="flex">
        <button class="btn" id="btnSettings">Settings ⚙️</button>
        <button class="btn" id="btnExport">Export CSV</button>
        <button class="btn" id="btnPrint">Print</button>
      </div>
    </div>
    <div class="controls">
      <input id="student" placeholder="Student name (optional)">
      <input id="date" type="date">
      <button class="btn" id="btnNewDay">New Day</button>
      <button class="btn" id="btnUndo">Undo</button>
      <span id="cloudStatus" class="badge">Local Only</span>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="summary">
    <div class="stat"><h3>Tokens Gained</h3><div id="gained" class="num earn">+$0</div></div>
    <div class="stat"><h3>Tokens Lost</h3><div id="lost" class="num loss">-$0</div></div>
    <div class="stat"><h3>Net Balance</h3><div id="net" class="num">0</div></div>
  </section>

  <section class="grid" id="lists"></section>

  <section class="card">
    <h2>History</h2>
    <div id="history" class="history"></div>
    <div class="sub">Hint: Use <strong>Export CSV</strong> to move data into Google Sheets.</div>
  </section>
</main>

<footer>Works offline (local storage). Cloud sync uses Firebase if you add your own keys.</footer>

<!-- Settings Modal -->
<div class="modal" id="modal">
  <div class="sheet">
    <header class="wrap">
      <div class="flex" style="justify-content:space-between">
        <h2 style="margin:6px 0">Settings</h2>
        <button class="btn" id="closeModal">Close ✕</button>
      </div>
    </header>
    <div class="body">
      <h3>Behaviors & Values</h3>
      <table class="table" id="itemsTable">
        <thead>
          <tr><th>Type</th><th>Name</th><th>Value</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="flex">
        <select id="newType">
          <option value="earn">Earn</option>
          <option value="lose">Lose</option>
        </select>
        <input id="newName" placeholder="Behavior name">
        <input id="newValue" type="number" placeholder="Value (e.g., 5 or -5)">
        <button class="btn primary" id="addItem">Add Item</button>
      </div>

      <hr style="margin:16px 0">

      <h3>General</h3>
      <div class="kv">
        <label>Currency symbol</label>
        <input id="currency" maxlength="3">
        <div></div><div class="sub">Shown before amounts (e.g., <code class="inline">$</code>). Default: <code class="inline">$</code></div>
      </div>
      <div class="flex" style="margin-top:8px">
        <button class="btn" id="btnResetDefaults">Reset to Defaults</button>
        <button class="btn" id="btnExportConfig">Export Settings</button>
        <input type="file" id="importFile" accept=".json" style="display:none">
        <button class="btn" id="btnImportConfig">Import Settings</button>
        <button class="btn" id="btnShareLink">Copy Share Link</button>
      </div>

      <hr style="margin:16px 0">

      <h3>Cloud Sync (Optional)</h3>
      <p class="sub">Paste your Firebase Web App keys (Realtime Database). Share the same <strong>Room ID</strong> with coworkers for live sync.</p>
      <div class="kv">
        <label>apiKey</label><input id="fb_apiKey">
        <label>authDomain</label><input id="fb_authDomain">
        <label>databaseURL</label><input id="fb_databaseURL" placeholder="https://YOUR-PROJECT-ID-default-rtdb.firebaseio.com">
        <label>projectId</label><input id="fb_projectId">
        <label>Room ID</label><input id="fb_roomId" placeholder="e.g., classroom-101">
      </div>
      <div class="flex" style="margin-top:8px">
        <button class="btn primary" id="btnEnableCloud">Enable Cloud Sync</button>
        <button class="btn ghost" id="btnDisableCloud">Disable Cloud</button>
        <span class="sub" id="cloudHint"></span>
      </div>
    </div>
  </div>
</div>

<script>
const DEFAULT_CONFIG = {
  currency: "$",
  items: [
    {type:"earn", name:"Doing affirmations correctly", value:3},
    {type:"earn", name:"Doing homework", value:2},
    {type:"earn", name:"Taking accountability", value:5},
    {type:"earn", name:"Listening to instructions", value:5},
    {type:"earn", name:"Using appropriate social skills", value:5},
    {type:"earn", name:"Waiting your turn to speak", value:4},
    {type:"earn", name:"Engaging in conversations appropriately", value:4},
    {type:"earn", name:"Transitioning in less than 10 seconds", value:3},
    {type:"lose", name:"Saying rude things", value:-5},
    {type:"lose", name:"Blaming others", value:-10},
    {type:"lose", name:"Lying", value:-10},
    {type:"lose", name:"Not taking accountability", value:-10},
    {type:"lose", name:"Kicking", value:-10},
    {type:"lose", name:"Hissing", value:-10},
    {type:"lose", name:"Hitting", value:-10},
    {type:"lose", name:"Negotiating", value:-10},
    {type:"lose", name:"Talking over others", value:-8},
    {type:"lose", name:"Transitioning in more than 10 seconds", value:-5},
  ]
};

const STORAGE_KEY = "token-tracker-team-v1";
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const state = {
  student: "",
  date: new Date().toISOString().slice(0,10),
  log: [],  // {ts, name, value, type}
  counts: {}, // name -> count
  cfg: structuredClone(DEFAULT_CONFIG),
  cloud: {enabled:false, roomId:null}
};

try{
  if(location.hash.startsWith("#config=")){
    const b64 = location.hash.slice(8);
    const json = atob(decodeURIComponent(b64));
    const parsed = JSON.parse(json);
    if(parsed && parsed.items){ state.cfg = parsed; }
  }
}catch(e){ console.warn("Bad config in URL", e); }

function save(){
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch{}
}
function load(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const parsed = JSON.parse(raw);
    if(parsed){
      state.student = parsed.student || state.student;
      state.date = parsed.date || state.date;
      state.log = Array.isArray(parsed.log) ? parsed.log : [];
      state.counts = parsed.counts || {};
      state.cfg = parsed.cfg || state.cfg;
      state.cloud = parsed.cloud || state.cloud;
    }
  } catch {}
}
load();

function buildLists(){
  const lists = $("#lists");
  lists.innerHTML = "";
  const earn = state.cfg.items.filter(x=>x.type==="earn");
  const lose = state.cfg.items.filter(x=>x.type==="lose");
  lists.appendChild(makeCard("Earn Tokens ✅", earn, "earn"));
  lists.appendChild(makeCard("Lose Tokens 🚫", lose, "loss"));
}
function makeCard(title, items, signClass){
  const card = document.createElement("section");
  card.className = "card";
  const h = document.createElement("h2"); h.textContent = title; card.appendChild(h);
  const list = document.createElement("div"); list.className = "list";
  items.forEach(it => {
    const row = document.createElement("div"); row.className = "row"; row.setAttribute("role","button"); row.tabIndex = 0;
    const name = document.createElement("div"); name.className = "name"; name.textContent = it.name;
    const value = document.createElement("div"); value.className = "value " + signClass; value.textContent = (it.value>0?"+":"") + state.cfg.currency + Math.abs(it.value);
    const count = document.createElement("div"); count.className = "count"; count.dataset.name = it.name; count.textContent = "x" + (state.counts[it.name]||0);
    const btn = document.createElement("button"); btn.textContent = "Add";
    const add = () => addEntry(it);
    btn.addEventListener("click", add);
    row.addEventListener("click", e => { if(e.target.tagName!=="BUTTON") add(); });
    row.addEventListener("keydown", e => { if(e.key==="Enter"||e.key===" "){ e.preventDefault(); add(); }});
    row.append(name, value, count, btn); list.appendChild(row);
  });
  card.appendChild(list); return card;
}
function renderSummary(){
  const gained = state.log.filter(e=>e.value>0).reduce((a,b)=>a+b.value,0);
  const lost = - state.log.filter(e=>e.value<0).reduce((a,b)=>a+b.value,0);
  const net = gained - lost;
  $("#gained").textContent = `+${state.cfg.currency}${gained}`;
  $("#lost").textContent = `-${state.cfg.currency}${lost}`;
  $("#net").textContent = `${net>=0?'+':''}${net}`;
  $$(".count").forEach(el => el.textContent = "x" + (state.counts[el.dataset.name]||0));
}
function renderHistory(){
  const host = $("#history"); host.innerHTML = "";
  if(state.log.length===0){ const p=document.createElement("div"); p.className="sub"; p.textContent="No entries yet — tap a behavior above."; host.appendChild(p); return; }
  state.log.slice().reverse().forEach((e, idx) => {
    const row = document.createElement("div"); row.className = "hist-row";
    const label = document.createElement("div"); label.innerHTML = `<strong>${e.name}</strong> <small>(${e.type})</small><br><small>${new Date(e.ts).toLocaleTimeString()}</small>`;
    const amt = document.createElement("div"); amt.className = "amt " + (e.value>0?"earn":"loss"); amt.textContent = (e.value>0?"+":"-") + state.cfg.currency + Math.abs(e.value);
    const day = document.createElement("div"); day.innerHTML = `<small>${state.date}</small>`;
    const btn = document.createElement("button"); btn.textContent = "Delete";
    btn.addEventListener("click", () => {
      const realIdx = state.log.length - 1 - idx;
      const removed = state.log.splice(realIndex=realIdx,1)[0];
      state.counts[removed.name] = Math.max(0, (state.counts[removed.name]||0) - 1);
      pushCloud(); save(); renderSummary(); renderHistory();
    });
    row.append(label, amt, day, btn); host.appendChild(row);
  });
}
function addEntry(it){
  const entry = {ts: Date.now(), name: it.name, value: it.value, type: it.type};
  state.log.push(entry);
  state.counts[it.name] = (state.counts[it.name]||0) + 1;
  pushCloud(); save(); renderSummary(); renderHistory();
}
document.getElementById("btnUndo").addEventListener("click", () => {
  const last = state.log.pop();
  if(last){ state.counts[last.name] = Math.max(0, (state.counts[last.name]||0) - 1); }
  pushCloud(); save(); renderSummary(); renderHistory();
});
document.getElementById("btnNewDay").addEventListener("click", () => {
  state.date = new Date().toISOString().slice(0,10);
  pushCloud(); save(); renderHistory(); renderSummary();
});
document.getElementById("btnExport").addEventListener("click", () => {
  const rows = [["Student","Date","Time","Type","Behavior","Amount"]];
  const name = (document.getElementById("student").value || state.student || "").replace(/,/g,"");
  state.log.forEach(e => rows.push([name, state.date, new Date(e.ts).toLocaleTimeString(), e.type, e.name.replace(/,/g,""), e.value]));
  const csv = rows.map(r=>r.join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `token_log_${state.date}.csv`; a.click();
});
document.getElementById("btnPrint").addEventListener("click", () => window.print());
document.getElementById("student").addEventListener("input", e => { state.student = e.target.value; pushCloud(); save(); });
document.getElementById("date").addEventListener("input", e => { state.date = e.target.value; pushCloud(); save(); });

document.getElementById("btnSettings").addEventListener("click", () => { openModal(); });
document.getElementById("closeModal").addEventListener("click", () => { closeModal(); });
document.getElementById("addItem").addEventListener("click", () => {
  const type = document.getElementById("newType").value;
  const name = document.getElementById("newName").value.trim();
  const val = Number(document.getElementById("newValue").value);
  if(!name || isNaN(val)) return alert("Enter a name and a numeric value.");
  state.cfg.items.push({type, name, value: val});
  document.getElementById("newName").value=""; document.getElementById("newValue").value="";
  save(); pushCloud(); refreshSettings(); buildLists(); renderSummary();
});
document.getElementById("btnResetDefaults").addEventListener("click", () => {
  if(!confirm("Reset items and currency to defaults?")) return;
  state.cfg = structuredClone(DEFAULT_CONFIG);
  save(); pushCloud(); refreshSettings(); buildLists(); renderSummary();
});
document.getElementById("btnExportConfig").addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(state.cfg,null,2)], {type:"application/json"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "token_settings.json"; a.click();
});
document.getElementById("btnImportConfig").addEventListener("click", () => document.getElementById("importFile").click());
document.getElementById("importFile").addEventListener("change", e => {
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const cfg = JSON.parse(reader.result);
      if(cfg && cfg.items){ state.cfg = cfg; save(); pushCloud(); refreshSettings(); buildLists(); renderSummary(); }
      else alert("Invalid config file.");
    }catch(err){ alert("Failed to parse JSON."); }
  };
  reader.readAsText(file);
});
document.getElementById("btnShareLink").addEventListener("click", () => {
  const json = JSON.stringify(state.cfg);
  const b64 = encodeURIComponent(btoa(json));
  const url = location.origin + location.pathname + "#config=" + b64;
  navigator.clipboard?.writeText(url);
  alert("Share link copied to clipboard!");
});
function refreshSettings(){
  document.getElementById("currency").value = state.cfg.currency || "$";
  const tbody = document.querySelector("#itemsTable tbody");
  tbody.innerHTML = "";
  state.cfg.items.forEach((it, i) => {
    const tr = document.createElement("tr");
    const tdType = document.createElement("td");
    const tdName = document.createElement("td");
    const tdValue = document.createElement("td");
    const tdAct = document.createElement("td");

    const sel = document.createElement("select");
    sel.innerHTML = `<option value="earn">Earn</option><option value="lose">Lose</option>`;
    sel.value = it.type; sel.addEventListener("change", e => { it.type = e.target.value; save(); pushCloud(); buildLists(); renderSummary(); });
    tdType.appendChild(sel);

    const nameIn = document.createElement("input"); nameIn.value = it.name;
    nameIn.addEventListener("input", e => { it.name = e.target.value; save(); pushCloud(); buildLists(); renderSummary(); });
    tdName.appendChild(nameIn);

    const valIn = document.createElement("input"); valIn.type="number"; valIn.value = it.value;
    valIn.addEventListener("input", e => { const v = Number(e.target.value); if(!isNaN(v)) { it.value = v; save(); pushCloud(); buildLists(); renderSummary(); } });
    tdValue.appendChild(valIn);

    const rm = document.createElement("button"); rm.className="btn"; rm.textContent="Remove";
    rm.addEventListener("click", () => {
      if(!confirm("Remove this item?")) return;
      state.cfg.items.splice(i,1); save(); pushCloud(); refreshSettings(); buildLists(); renderSummary();
    });
    tdAct.appendChild(rm);

    tr.append(tdType, tdName, tdValue, tdAct);
    tbody.appendChild(tr);
  });
}
document.getElementById("currency").addEventListener("input", e => { state.cfg.currency = e.target.value || "$"; save(); pushCloud(); buildLists(); renderSummary(); });

function openModal(){ document.getElementById("modal").classList.add("open"); refreshSettings(); }
function closeModal(){ document.getElementById("modal").classList.remove("open"); }

let fb = null;
async function enableCloudSync(cfg, roomId){
  if(!roomId) { alert("Please enter a Room ID."); return; }
  if(!window.firebase){
    await Promise.all([
      loadScript("https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"),
      loadScript("https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"),
      loadScript("https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js")
    ]);
  }
  try{
    const app = firebase.apps[0] || firebase.initializeApp(cfg);
    await firebase.auth().signInAnonymously();
    const db = firebase.database();
    const roomRef = db.ref("rooms/"+roomId);
    state.cloud.enabled = true; state.cloud.roomId = roomId;
    document.getElementById("cloudStatus").textContent = "Cloud: "+roomId;
    document.getElementById("cloudStatus").style.background = "#dcfce7"; document.getElementById("cloudStatus").style.color = "#065f46";
    await roomRef.child("state").set({student:state.student,date:state.date,log:state.log,counts:state.counts,cfg:state.cfg});
    roomRef.child("state").on("value", snap => {
      const d = snap.val(); if(!d) return;
      state.student = d.student || state.student;
      state.date = d.date || state.date;
      state.log = Array.isArray(d.log)? d.log : state.log;
      state.counts = d.counts || state.counts;
      state.cfg = d.cfg || state.cfg;
      save(); buildLists(); renderSummary(); renderHistory();
    });
    fb = {app, db, roomRef};
    document.getElementById("cloudHint").textContent = "Active. Share this Room ID with coworkers.";
  }catch(e){
    console.error(e);
    alert("Failed to enable cloud sync. Check keys and databaseURL.");
  }
}
async function disableCloudSync(){
  if(fb && fb.roomRef){ fb.roomRef.off(); }
  fb = null; state.cloud.enabled=false; state.cloud.roomId=null;
  document.getElementById("cloudStatus").textContent = "Local Only"; document.getElementById("cloudStatus").style.background = "#eef2ff"; document.getElementById("cloudStatus").style.color="#3730a3";
  document.getElementById("cloudHint").textContent = "Cloud disabled.";
  save();
}
async function pushCloud(){
  if(fb && state.cloud.enabled && state.cloud.roomId){
    try{ await fb.roomRef.child("state").set({student:state.student,date:state.date,log:state.log,counts:state.counts,cfg:state.cfg}); }catch(e){}
  }
}
function loadScript(src){
  return new Promise((res, rej) => {
    const s = document.createElement("script"); s.src = src; s.async=true; s.onload=res; s.onerror=rej; document.head.appendChild(s);
  });
}
document.getElementById("btnEnableCloud").addEventListener("click", () => {
  const cfg = {
    apiKey: document.getElementById("fb_apiKey").value.trim(),
    authDomain: document.getElementById("fb_authDomain").value.trim(),
    databaseURL: document.getElementById("fb_databaseURL").value.trim(),
    projectId: document.getElementById("fb_projectId").value.trim(),
  };
  const roomId = document.getElementById("fb_roomId").value.trim();
  if(!cfg.apiKey || !cfg.authDomain || !cfg.databaseURL || !cfg.projectId){ alert("Please fill all Firebase fields."); return; }
  enableCloudSync(cfg, roomId);
});
document.getElementById("btnDisableCloud").addEventListener("click", () => { disableCloudSync(); });

document.getElementById("student").value = state.student || "";
document.getElementById("date").value = state.date;
buildLists(); renderSummary(); renderHistory();
if(state.cloud.enabled && state.cloud.roomId){
  document.getElementById("fb_roomId").value = state.cloud.roomId;
  document.getElementById("cloudHint").textContent = "Reconnecting…";
}
</script>
</body>
</html>
